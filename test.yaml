blueprint:
  name: Flashed Moe's Zigbee Switch - Detached Mode - Extended - WITH Light Options
  author: jzxandy
  description: >
    ## ðŸ”˜ Toggle Light(s) with Button(s) and Sync LED Indicator(s)


    Control lights using one or more momentary toggle buttons and have indicator LEDs synchronised with the opposite state.  



    This blueprint supports optional settings to dial in specific brightness, transition (on and off), and RGB/RGBW/RGBWW colours for your light(s).

    - ðŸ” Triggered if any of the "Button Toggle(s)" change from **released â†’ press** (applicable to custom flashed Moe's light switches).

    - ðŸ’¡ Toggles the `main_entity` (referred to below as "Light(s)") on/off.

    - ðŸ”„ Optionally toggles an `alternating_entity` (e.g. LED indicator(s) on light switch button, referred to below as the "LED Indicator(s)") to the *inverse* of the state of your selected light(s)

    - âœ… Quick set-up, especially for applications where 3 or more buttons are intended to control the same light(s) and you want the LED Indicators on each button to be synced in some way.

    - ðŸ”„ Reusable across different button groups and lights.


    [Info - contact - feedback](https://github.com/jzxandy/HA-Blueprints)



    ### ðŸ”§ Device Compatibility


    This blueprint is made for use with Moeâ€™s Zigbee switches flashed with custom firmware and makes automating light controls in detached mode easier. Compatible Moe's zigbee switch models include:  

    - **TS0011** (1 gang - OTA FLASH COMPATIBLE)  

    - **TS0012** (2 gang - OTA FLASH COMPATIBLE)  

    - **TS0013** (3 gang - OTA FLASH COMPATIBLE)  

    - **TS0014** (4-gang - REQUIRES HARDWARE FLASHER)  


    These are no-neutral Tuya Zigbee switches and should be readily available for purchase on AliExpress.

   
    You can obtain the custom firmware for these switches (and other Tuya devices) thanks to Romasku [here](https://github.com/romasku/tuya-zigbee-switch).


    ### âš™ï¸ Zigbee2MQTT Setup Requirements:

    **For each button (referred to below as "Button Toggle(s)"):**  

    - `Switch x mode (Endpoint: switch_x)` - `MOMENTARY`  

    - `Switch x action mode (Endpoint: switch_x)` - `TOGGLE_SIMPLE`



    **For each relay that you want to supply constant power to your light(s):**  



    - `Switch x relay mode (Endpoint: switch_x)` - `LONG_PRESS` - (this allows you to manually toggle the relay in question, by long-pressing the corresponding physical button)

    - `State (Endpoint: relay_x)` - `ON`  

    - `Power-on behavior (Endpoint: relay_x)` - `ON`

  domain: automation
  input:
    buttons_switches:
      name: "Buttons / Switches *"
      icon: mdi:light-switch
      collapsed: true
      input:
        toggle_switch:
          name: Button Toggle(s) *
          description: One or more flashed Moe's "switch press action switch" entity to control the lights. Each button in this list will control the light(s).
          selector:
            entity:
              domain: sensor
              multiple: true
    lights:
      name: "Lights *"
      icon: mdi:lightbulb-group
      collapsed: true
      input:
        main_entity:
          name: Light(s) *
          description: Select the single or group light entity (or entities) that you want your button(s) to control simultaneously.
          selector:
            entity:
              domain: light
              multiple: true
    light_controls:
      name: "Light Controls"
      icon: mdi:lightbulb-on-outline
      collapsed: true
      input:
        include_light_control:
          name: Light Control Options
          description: Optional - Tick as applicable.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Use Brightness
                  value: use_brightness
                - label: Use Transition
                  value: use_transition
        light_brightness:
          name: Brightness (%)
          description: Brightness applied when light is turned on by button toggles.
          default: 100
          selector:
            number:
              min: 1
              max: 100
              step: 1
              unit_of_measurement: '%'
              mode: slider
        light_transition_on:
          name: Transition On (s)
          description: Duration for light(s) to go from "off" to maximum brightness.
          default: 1
          selector:
            number:
              min: 0
              max: 10
              step: 0.5
              unit_of_measurement: 's'
              mode: slider
        light_transition_off:
          name: Transition Off (s)
          description: Duration for light(s) to fully dim.
          default: 1
          selector:
            number:
              min: 0
              max: 30
              step: 1
              unit_of_measurement: 's'
              mode: slider
        include_light_colour_control:
          name: Light Colour Options
          description: Optional - Colour temp for white, RGB for colours, RGBW or RGBWW for multiple channels.
          default: disable_colour_control
          selector:
            select:
              options:
                - label: Use Colour Temperature
                  value: use_colour_temperature
                - label: Use RGB Colour
                  value: use_rgb_colour
                - label: Use RGBW Colour
                  value: use_rgbw_colour
                - label: Use RGBWW Colour
                  value: use_rgbww_colour
                - label: Disable Colour Control
                  value: disable_colour_control
        light_colour_temperature:
          name: Colour Temperature (Kelvin)
          description: Only works when "Use Colour Temperature" is selected.
          default: 5000
          selector:
            number:
              min: 2000
              max: 8000
              step: 100
              unit_of_measurement: 'K'
              mode: slider
        light_rgb_colour:
          name: RGB Colour
          description: Only works when "Use RGB Colour" is selected.
          default: [255, 255, 255]
          selector:
            color_rgb:
        light_rgbw_colour:
          name: RGBW Colour
          description: Only works when "Use RGBW Colour" is selected.
          default: [255, 255, 255, 255]
          selector:
            object:
        light_rgbww_colour:
          name: RGBWW Colour
          description: Only works when "Use RGBWW Colour" is selected.
          default: [255, 255, 255, 255, 255]
          selector:
            object:
    led_indicators:
      name: "LED Indicators"
      icon: mdi:led-on
      collapsed: true
      input:
        alternating_entity:
          name: LED Indicator(s)
          description: Optional - Automatically sync LED indicator(s) to reflect the opposite state of your light(s).
          default: []
          selector:
            entity:
              domain: switch
              multiple: true
mode: single

variables:
  main_entity: !input main_entity
  alternating_entity: !input alternating_entity
  include_light_control: !input include_light_control
  light_brightness: !input light_brightness
  light_transition_on: !input light_transition_on
  light_transition_off: !input light_transition_off
  include_light_colour_control: !input include_light_colour_control
  light_colour_temperature: !input light_colour_temperature
  light_rgb_colour: !input light_rgb_colour
  light_rgbw_colour: !input light_rgbw_colour
  light_rgbww_colour: !input light_rgbww_colour

  light_data: >
    {% set light = namespace(data={}) %}
    {% if 'use_transition' in include_light_control %}
      {% set light.data = dict(light.data, transition=light_transition_on) %}
    {% endif %}
    {% if 'use_brightness' in include_light_control %}
      {% set light.data = dict(light.data, brightness_pct=light_brightness) %}
    {% endif %}
    {% if include_light_colour_control == 'use_colour_temperature' %}
      {% set light.data = dict(light.data, color_temp_kelvin=light_colour_temperature) %}
    {% elif include_light_colour_control == 'use_rgb_colour' %}
      {% set light.data = dict(light.data, rgb_color=light_rgb_colour) %}
    {% elif include_light_colour_control == 'use_rgbw_colour' %}
      {% set light.data = dict(light.data, rgbw_color=light_rgbw_colour) %}
    {% elif include_light_colour_control == 'use_rgbww_colour' %}
      {% set light.data = dict(light.data, rgbww_color=light_rgbww_colour) %}
    {% endif %}
    {{ light.data }}

trigger:
  - platform: state
    entity_id: !input toggle_switch
    from: "released"
    to: "press"

action:
  - choose:
      - conditions: "{{ alternating_entity == [] }}"
        sequence:
          - choose:
              - conditions: "{{ expand(main_entity) | selectattr('state', 'eq', 'on') | list | count > 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input main_entity
                    data:
                      transition: "{{ light_transition_off if 'use_transition' in include_light_control else 0 }}"
              - conditions: "{{ expand(main_entity) | selectattr('state', 'eq', 'off') | list | count == expand(main_entity) | list | count }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input main_entity
                    data: "{{ light_data }}"
    default:
      - choose:
          - conditions: "{{ expand(main_entity) | selectattr('state', 'eq', 'on') | list | count > 0 }}"
            sequence:
              - service: light.turn_off
                target:
                  entity_id: !input main_entity
                data:
                  transition: "{{ light_transition_off if 'use_transition' in include_light_control else 0 }}"
              - service: switch.turn_on
                target:
                  entity_id: !input alternating_entity
          - conditions: "{{ expand(main_entity) | selectattr('state', 'eq', 'off') | list | count == expand(main_entity) | list | count }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: !input main_entity
                data: "{{ light_data }}"
              - service: switch.turn_off
                target:
                  entity_id: !input alternating_entity
